CREATE TABLE users (
    user_id NUMBER GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    username VARCHAR2(255) UNIQUE NOT NULL,
    email VARCHAR2(255) UNIQUE NOT NULL,
    password_hash VARCHAR2(255) NOT NULL,
    salt VARCHAR2(255) NOT NULL,
    is_active NUMBER(1) DEFAULT 0,
    account_status VARCHAR2(50) DEFAULT 'PENDING',
    created_by NUMBER,
    approved_by NUMBER,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    last_login TIMESTAMP,
    password_reset_token VARCHAR2(255),
    password_reset_expires TIMESTAMP,
    failed_login_attempts NUMBER DEFAULT 0,
    FOREIGN KEY (created_by) REFERENCES users(user_id),
    FOREIGN KEY (approved_by) REFERENCES users(user_id)
);

CREATE INDEX idx_users_username ON users(username);



CREATE TABLE user_profiles (
    profile_id NUMBER GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    user_id NUMBER UNIQUE NOT NULL,
    first_name VARCHAR2(100) NOT NULL,
    last_name VARCHAR2(100) NOT NULL,
    phone_number VARCHAR2(20),
    department VARCHAR2(100),
    position VARCHAR2(100),
    profile_image_path VARCHAR2(500),
    FOREIGN KEY (user_id) REFERENCES users(user_id)
);


CREATE TABLE roles (
    role_id NUMBER GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    role_name VARCHAR2(100) UNIQUE NOT NULL,
    description VARCHAR2(500),
    is_system_role NUMBER(1) DEFAULT 0
);


CREATE TABLE user_roles (
    user_role_id NUMBER GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    user_id NUMBER NOT NULL,
    role_id NUMBER NOT NULL,
    assigned_by NUMBER NOT NULL,
    assigned_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    FOREIGN KEY (user_id) REFERENCES users(user_id),
    FOREIGN KEY (role_id) REFERENCES roles(role_id),
    FOREIGN KEY (assigned_by) REFERENCES users(user_id),
    CONSTRAINT uq_user_role UNIQUE (user_id, role_id)
);


CREATE TABLE permission_matrix (
    permission_id NUMBER GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    role_id NUMBER NOT NULL,
    module_name VARCHAR2(100) NOT NULL,
    can_view NUMBER(1) DEFAULT 0,
    can_create NUMBER(1) DEFAULT 0,
    can_edit NUMBER(1) DEFAULT 0,
    can_delete NUMBER(1) DEFAULT 0,
    FOREIGN KEY (role_id) REFERENCES roles(role_id),
    CONSTRAINT uq_role_module UNIQUE (role_id, module_name)
);


CREATE TABLE password_history (
    history_id NUMBER GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    user_id NUMBER NOT NULL,
    password_hash VARCHAR2(255) NOT NULL,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    FOREIGN KEY (user_id) REFERENCES users(user_id)
);


CREATE TABLE login_audit_log (
    log_id NUMBER GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    user_id NUMBER,
    target_user_id NUMBER,
    login_timestamp TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    ip_address VARCHAR2(45) NOT NULL,
    login_status VARCHAR2(20) NOT NULL,  -- Enforce ENUM in application logic
    login_type VARCHAR2(20) NOT NULL,    -- Enforce ENUM in application logic
    details CLOB,
    FOREIGN KEY (user_id) REFERENCES users(user_id),
    FOREIGN KEY (target_user_id) REFERENCES users(user_id)
);
